// Verita Platform - Combined Schema
// This schema combines job marketplace, contractor management, and payments

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum ContractorStatus {
  APPLIED
  INTERVIEWING
  ONBOARDING
  PENDING_CHECKR
  ACTIVE
  PAUSED
  OFFBOARDED
}

enum CheckrStatus {
  NOT_STARTED
  PENDING
  CLEAR
  CONSIDER
  SUSPENDED
  EXPIRED
}

enum DocumentType {
  NDA
  CIIAA
  TERMS_OF_WORK
  OFFER_LETTER
  W8_BEN
  W9
  RESUME
  ID_DOCUMENT
  OTHER
}

enum DocumentStatus {
  PENDING
  SENT
  VIEWED
  SIGNED
  EXPIRED
  GENERATED
}

enum TimeEntryStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TimeEntrySource {
  INSIGHTFUL
  INHOUSE
  MANUAL
  PIPELINE
}

enum PaymentStatus {
  PENDING
  APPROVED
  PROCESSING
  IN_TRANSIT
  PAID
  FAILED
  CANCELLED
}

enum ProjectStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum JobStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

enum PayType {
  HOURLY
  PER_TASK
}

enum ApplicationStatus {
  NEW
  REVIEWING
  SHORTLISTED
  INTERVIEWING
  OFFERED
  REJECTED
  HIRED
  WITHDRAWN
}

enum ApplicationSource {
  LINKEDIN
  TWITTER
  REFERRAL
  GOOGLE
  DIRECT
  OTHER
}

enum UserRole {
  OPS
  ADMIN
  SUPER_ADMIN
}

// ============================================
// JOB MARKETPLACE MODELS
// ============================================

model Job {
  id                  String        @id @default(cuid())
  title               String
  slug                String        @unique
  status              JobStatus     @default(DRAFT)

  // Compensation
  payMin              Int
  payMax              Int
  payType             PayType       @default(HOURLY)

  // Details
  timeCommitment      String
  remoteWorldwide     Boolean       @default(true)
  allowedCountries    String[]
  shortDescription    String        @db.VarChar(500)
  fullDescription     String        @db.Text
  responsibilities    String        @db.Text
  requirements        String        @db.Text
  niceToHave          String?       @db.Text

  // Skills & Tools
  tools               String[]
  skillTags           String[]

  // Limits
  applicationDeadline DateTime?
  maxApplications     Int?

  // Timestamps
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  publishedAt         DateTime?

  // Relations
  createdById         String?
  createdBy           User?         @relation(fields: [createdById], references: [id])
  applications        Application[]

  @@index([status])
  @@index([slug])
}

model Application {
  id                 String            @id @default(cuid())
  jobId              String

  // Applicant Info
  fullName           String
  email              String
  phone              String
  country            String
  timezone           String?

  // Links
  resumeUrl          String?
  linkedinUrl        String?
  portfolioUrl       String?
  githubUrl          String?

  // Responses
  whyInterested      String            @db.Text
  relevantExperience String            @db.Text
  expectedRate       Int?
  availableHours     Int?
  startDate          DateTime?

  // Tracking
  source             ApplicationSource @default(OTHER)
  status             ApplicationStatus @default(NEW)

  // AI Interview
  interviewId        String?
  interviewStatus    String?
  interviewScore     Int?
  interviewCompletedAt DateTime?

  // Timestamps
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  // Relations
  job                Job               @relation(fields: [jobId], references: [id])
  notes              ApplicationNote[]
  contractor         Contractor?

  @@index([jobId])
  @@index([email])
  @@index([status])
}

model ApplicationNote {
  id            String      @id @default(cuid())
  applicationId String
  authorId      String
  authorName    String
  noteText      String      @db.Text
  createdAt     DateTime    @default(now())

  application   Application @relation(fields: [applicationId], references: [id])

  @@index([applicationId])
}

// ============================================
// CONTRACTOR & OPERATIONS MODELS
// ============================================

model Contractor {
  id                  String            @id @default(cuid())

  // Basic Info
  firstName           String
  lastName            String
  email               String            @unique
  phone               String?
  country             String
  timezone            String?

  // Profile
  bio                 String?           @db.Text
  skills              String[]

  // Status
  status              ContractorStatus  @default(ONBOARDING)
  onboardingStep      Int               @default(0)
  onboardingComplete  Boolean           @default(false)
  paymentEligible     Boolean           @default(false)

  // Compensation
  hourlyRate          Decimal           @db.Decimal(10, 2)
  weeklyCap           Int?
  currency            String            @default("USD")

  // External IDs
  deelContractId      String?           @unique
  deelEmployeeId      String?
  insightfulUserId    String?           @unique
  clerkUserId         String?           @unique

  // Checkr Integration
  checkrCandidateId   String?
  checkrInvitationId  String?
  checkrReportId      String?
  checkrStatus        CheckrStatus      @default(NOT_STARTED)
  checkrCompletedAt   DateTime?

  // Source tracking
  applicationId       String?           @unique
  application         Application?      @relation(fields: [applicationId], references: [id])
  referredBy          String?

  // Timestamps
  startDate           DateTime?
  endDate             DateTime?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relations
  documents           Document[]
  timeEntries         TimeEntry[]
  payments            Payment[]
  projectAssignments  ProjectAssignment[]
  notes               ContractorNote[]

  @@index([status])
  @@index([email])
  @@index([checkrStatus])
}

model Document {
  id              String          @id @default(cuid())

  contractorId    String
  type            DocumentType
  status          DocumentStatus  @default(PENDING)

  fileName        String?
  version         String?
  fileUrl         String?

  sentAt          DateTime?
  viewedAt        DateTime?
  signedAt        DateTime?
  expiresAt       DateTime?

  signatureData   Json?
  metadata        Json?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  contractor      Contractor      @relation(fields: [contractorId], references: [id])

  @@index([contractorId])
  @@index([type])
  @@index([status])
}

model Project {
  id                    String          @id @default(cuid())

  // Basic Info
  name                  String
  code                  String          @unique
  client                String?
  description           String?         @db.Text

  // Budget & Status
  status                ProjectStatus   @default(ACTIVE)
  budget                Decimal?        @db.Decimal(12, 2)
  budgetAlertAt         Decimal?        @db.Decimal(12, 2)

  // Time tracking config
  payProductiveOnly     Boolean         @default(true)
  nonProductiveDelta    Decimal         @default(0) @db.Decimal(3, 2)

  // Timestamps
  startDate             DateTime?
  endDate               DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  // Relations
  assignments           ProjectAssignment[]
  timeEntries           TimeEntry[]

  @@index([status])
  @@index([code])
}

model ProjectAssignment {
  id              String      @id @default(cuid())

  contractorId    String
  projectId       String

  role            String?
  hourlyRate      Decimal?    @db.Decimal(10, 2)
  weeklyCap       Int?

  status          String      @default("ACTIVE")
  assignedAt      DateTime    @default(now())
  removedAt       DateTime?

  contractor      Contractor  @relation(fields: [contractorId], references: [id])
  project         Project     @relation(fields: [projectId], references: [id])

  @@unique([projectId, contractorId])
  @@index([contractorId])
  @@index([projectId])
}

model TimeEntry {
  id                  String          @id @default(cuid())

  contractorId        String
  projectId           String?

  date                DateTime        @db.Date
  totalHours          Decimal         @db.Decimal(5, 2)
  productiveHours     Decimal?        @db.Decimal(5, 2)
  nonProductiveHours  Decimal?        @db.Decimal(5, 2)

  source              TimeEntrySource
  externalId          String?
  syncedAt            DateTime?

  status              TimeEntryStatus @default(PENDING)
  approvedBy          String?
  approvedAt          DateTime?

  paymentId           String?

  notes               String?
  screenshotCount     Int?

  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  contractor          Contractor      @relation(fields: [contractorId], references: [id])
  project             Project?        @relation(fields: [projectId], references: [id])
  payment             Payment?        @relation(fields: [paymentId], references: [id])

  @@unique([contractorId, date, source, externalId])
  @@index([contractorId])
  @@index([projectId])
  @@index([date])
  @@index([status])
}

model Payment {
  id              String          @id @default(cuid())

  contractorId    String

  periodStart     DateTime        @db.Date
  periodEnd       DateTime        @db.Date

  totalHours      Decimal         @db.Decimal(6, 2)
  hourlyRate      Decimal         @db.Decimal(10, 2)
  grossAmount     Decimal         @db.Decimal(12, 2)
  netAmount       Decimal         @db.Decimal(12, 2)
  currency        String          @default("USD")

  status          PaymentStatus   @default(PENDING)

  deelPaymentId   String?         @unique
  deelInvoiceId   String?
  deelStatus      String?

  approvedAt      DateTime?
  approvedBy      String?
  submittedAt     DateTime?
  processedAt     DateTime?
  paidAt          DateTime?
  failedAt        DateTime?
  failureReason   String?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  contractor      Contractor      @relation(fields: [contractorId], references: [id])
  timeEntries     TimeEntry[]

  @@index([contractorId])
  @@index([status])
  @@index([periodStart, periodEnd])
}

model ContractorNote {
  id              String      @id @default(cuid())

  contractorId    String
  authorId        String
  authorName      String

  content         String      @db.Text

  createdAt       DateTime    @default(now())

  contractor      Contractor  @relation(fields: [contractorId], references: [id])

  @@index([contractorId])
}

// ============================================
// SYSTEM MODELS
// ============================================

model User {
  id               String            @id @default(cuid())
  email            String            @unique
  clerkUserId      String?           @unique
  name             String
  role             UserRole          @default(OPS)

  createdAt        DateTime          @default(now())
  lastLogin        DateTime?

  jobs             Job[]

  @@index([email])
}

model SyncLog {
  id                String      @id @default(cuid())

  source            String
  action            String
  status            String

  recordsProcessed  Int         @default(0)
  recordsFailed     Int         @default(0)

  errorMessage      String?
  metadata          Json?

  startedAt         DateTime    @default(now())
  completedAt       DateTime?
}

model AuditLog {
  id              String      @id @default(cuid())

  userId          String
  userName        String

  action          String
  entityType      String
  entityId        String

  previousValue   Json?
  newValue        Json?

  ipAddress       String?
  userAgent       String?

  createdAt       DateTime    @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}
